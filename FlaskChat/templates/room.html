{% extends 'base.html' %} {% block content %}
<div id="room-container">
  <h1 id="home-header">Flask Chat ðŸ’¬</h1>
  <div id="room-subsection">
    <h2 id="room-code-display">Room Code: <span>{{room}}</span></h2>
    <a href="/" id="leave-chat-btn">Leave the Chat</a>
  </div>

  <div id="chat-room-widget">
    <div id="msgs-container">
      <ul id="messages"></ul>
    </div>

    <div id="message-box">
      <input
        type="text"
        placeholder="Enter your message"
        id="message-input"
        name="message"
      />
      <button type="submit" id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script type="text/javascript">
    /*
        establish a WebSocket connection to the server, listens for incoming "message" events, 
        and dynamically adds chat messages to the HTML document's "messages" container based on 
        whether they are system messages or user messages. It also applies different styles to 
        user messages based on whether the sender is the user or another participant.
    */
    var socketio = io();

    socketio.on("message", function (message) {
      createChatItem(message.message, message.sender);
    });

    function createChatItem(message, sender) {
      var messages = document.getElementById("messages");

      if (sender === "") {
        content = `
          <p class="member-activity">${message}</p>
        `;
      } else {
        var senderIsUser = "{{user}}" === sender;
        var content = `
          <li class="message-item ${
            senderIsUser ? "self-message-item" : "peer-message-item"
          }">
              <p>${message}</p>
              <small class="${
                senderIsUser ? "muted-text" : "muted-text-white"
              }">${new Date().toLocaleString()}</small>
          </li>
      `;
      }

      messages.innerHTML += content;
    }

    /*
         function is called when the user wants to send a chat message. It retrieves the message 
         from the input field, sends it to the server using a WebSocket connection by emitting a 
         "message" event, and then clears the input field to prepare for the next message
    */

    function sendMessage() {
      var msgInput = document.getElementById("message-input");
      if (msgInput.value === "") return;

      var msg = msgInput.value;
      socketio.emit("message", { message: msg });
      msgInput.value = "";
    }
  </script>

  {% for message in messages %}
  <script type="text/javascript">
    createChatItem("{{message.message}}", "{{message.sender}}");
  </script>
  {% endfor %}
</div>
{% endblock %}
